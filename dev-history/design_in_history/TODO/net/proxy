# shellcheck shell=bash

proxy.git.enable.with_socks5(){
    local HOST_PORT="${1:?"Accept one argument like '127.0.0.1:7070', 'localhost:18000', or 'user@pass:127.0.0.1:7070'"}"
    git config --global http.proxy "socks://$HOST_PORT"
    git config --global https.proxy "socks://$HOST_PORT"

    {
        echo "# This file is auto-generated by x-bash."
        echo "# For more information, please visit https://github.com/x-bash/x-bash.github.io/tree/master/net/proxy."
    } > "$HOME/.ssh/x-bash.net.proxy.config"

    local ALL=${GIT_REPO_HOST_LIST:-'github.com bitbucket.com'}
    for i in $ALL; do
        echo "
Host $i
    ProxyCommand=nc -X 5 -x $HOST_PORT %h %p
" >> "$HOME/.ssh/x-bash.net.proxy.config"
    done

    grep "Include x-bash.net.proxy.config" "$HOME/.ssh/config" 1>/dev/null || {
        # Not every host have sed or awk.
        local a=$HOME/.ssh/config
        local b=$HOME/.ssh/config.x-cmd.com
        (echo "Include x-bash.net.proxy.config" && cat "$a") > "$b" && mv "$b" "$a"
    }
}

proxy.git.disable(){
    # Not every host have sed or awk.
    local a=$HOME/.ssh/config
    local b=$HOME/.ssh/config.x-cmd.com
    grep -v "Include x-bash.net.proxy.config" "$a" > "$b" && mv "$b" "$a"

    git config --unset --global http.proxy
    git config --unset --global https.proxy
}

proxy.env.enable.with_socks5(){
    local HOST_PORT="${1:?"Host like '127.0.0.1', 'localhost', or 'user@pass:127.0.0.1:7070'"}"
    
    export all_proxy=socks5://$HOST_PORT
    export ALL_PROXY=socks5://$HOST_PORT

    export http_proxy=socks5://$HOST_PORT
    export HTTP_PROXY=socks5://$HOST_PORT

    export https_proxy=socks5://$HOST_PORT
    export HTTPS_PROXY=socks5://$HOST_PORT
}

proxy.env.unset(){ 
    export all_proxy=
    export ALL_PROXY=

    export http_proxy=
    export HTTP_PROXY=

    export https_proxy=
    export HTTPS_PROXY=
}
